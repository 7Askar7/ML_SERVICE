# ML_SERVICE

## Обзор (Overview)

Голосовой репетитор - это комплексное приложение, предназначенное для помощи в изучении иностранных языков. Оно построено с использованием FastAPI для API, Celery для асинхронных задач и включает в себя полный набор инструментов для мониторинга, трассировки и управления очередями задач. Проект оптимизирован для работы с GPU NVIDIA благодаря использованию соответствующих Docker-образов и конфигураций.

## Возможности (Features)

*   **API на FastAPI**: Высокопроизводительный API для взаимодействия с моделями и управления задачами.
*   **Асинхронные задачи с Celery**: Обработка длительных задач (например, ASR - распознавание речи) в фоновом режиме.
*   **Поддержка GPU**: Оптимизировано для вычислений на GPU NVIDIA.
*   **Мониторинг**: Интеграция с Prometheus, Node Exporter и DCGM Exporter для сбора метрик системы и GPU.
*   **Трассировка**: Интеграция с Jaeger для распределенной трассировки запросов.
*   **Управление очередями**: Использование Redis в качестве брокера сообщений для Celery.
*   **Контейнеризация**: Полностью контейнеризированное приложение с использованием Docker и Docker Compose для легкого развертывания и масштабирования.

## Технологический стек (Technology Stack)

*   **Backend**: Python, FastAPI
*   **Асинхронные задачи**: Celery
*   **База данных/Брокер сообщений**: Redis
*   **Контейнеризация**: Docker, Docker Compose
*   **Мониторинг**: Prometheus, Node Exporter, DCGM Exporter, Celery Exporter
*   **Трассировка**: Jaeger
*   **Основа для ML**: PyTorch, CUDA, cuDNN


## Начало работы (Getting Started)

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/7Askar7/ML_SERVICE.git
    cd ML_SERVICE
    ```

2.  **Соберите и запустите контейнеры:**
    ```bash
    docker-compose up --build -d
    ```
    Эта команда соберет образы (если они еще не собраны) и запустит все сервисы в фоновом режиме.

3.  **Проверка работы:**
    *   API FastAPI будет доступен по адресу: `http://localhost:8000`
    *   Prometheus: `http://localhost:9090`
    *   Jaeger UI: `http://localhost:16686`

## Сервисы (Services)

Проект состоит из следующих сервисов, определенных в `docker-compose.yml`:

*   `redis`: Сервер Redis, используемый в качестве брокера Celery и бэкенда результатов.
*   `fastapi_app`: Основное приложение FastAPI, предоставляющее API.
*   `celery_worker`: Воркеры Celery, выполняющие асинхронные задачи (включая задачи с высоким приоритетом для ASR).
*   `prometheus`: Система мониторинга Prometheus для сбора метрик.
*   `node-exporter`: Экспортер метрик хост-системы для Prometheus.
*   `celery-exporter`: Экспортер метрик Celery для Prometheus.
*   `jaeger`: Система распределенной трассировки Jaeger.
*   `dcgm-exporter`: Экспортер метрик GPU NVIDIA для Prometheus.

## Мониторинг и Трассировка (Monitoring and Tracing)

*   **Prometheus**: Доступен по адресу `http://localhost:9090`. Собирает метрики со всех экспортеров.
*   **Jaeger**: Доступен по адресу `http://localhost:16686`. Позволяет отслеживать запросы через различные сервисы.
*   **DCGM Exporter**: Метрики GPU (если доступны) будут видны в Prometheus.

## Структура директорий (Directory Structure - примерная)

```
.
├── app/                     # Исходный код приложения FastAPI и Celery
│   ├── core/                # Основная логика, конфигурация Celery
│   ├── services/            # Сервисы, бизнес-логика
│   ├── auth/                # Логика аутентификации 
│   ├── static/              # Сайт
│   ├── configs.py           # Конфигурации приложения
│   └── main.py              # Точка входа FastAPI приложения
├── etc/                     # Файлы конфигурации для внешних сервисов
│   └── prometheus/
│       └── prometheus.yml   # Конфигурация Prometheus
├── requirements.txt         # Зависимости Python
├── Dockerfile               # Dockerfile для сборки образов
├── docker-compose.yml       # Docker Compose конфигурация
└── README.md                # Этот файл
```

## Остановка приложения

Чтобы остановить все сервисы:
```bash
docker-compose down
```

Чтобы остановить и удалить все тома:
```bash
docker-compose down -v
```

## Архитектура и Схема Работы (Architecture and Workflow Diagram)

Ниже представлена упрощенная схема взаимодействия компонентов системы:

#TODO

**Описание потока:**

1.  **Пользователь** отправляет HTTP-запрос (на распознавание речи) к `FastAPI Приложению`.
2.  `FastAPI Приложение`:
    *   Если запрос может быть обработан синхронно и быстро, оно выполняет операцию и возвращает `Ответ Пользователю`.
    *   Для длительных операций (например, ASR), FastAPI отправляет задачу в `Redis` (который выступает как брокер сообщений Celery).
3.  `Celery Worker` забирает задачу из очереди в `Redis`.
4.  При необходимости (например, для ML-вычислений) `Celery Worker` использует ресурсы `NVIDIA GPU`.
5.  После выполнения задачи `Celery Worker` сохраняет результат обратно в `Redis` (который также выступает как бэкенд результатов Celery).
6.  `FastAPI Приложение` может опросить `Redis` для получения результата задачи и вернуть его пользователю, либо пользователь может получить результат по другому механизму (например, через webhook или отдельный запрос статуса задачи).
7.  **Мониторинг и Трассировка**:
    *   `FastAPI` и `Celery Worker` отправляют данные для трассировки в `Jaeger`.
    *   Все основные компоненты (`FastAPI`, `Celery Worker`), а также специализированные экспортеры (`Node Exporter` для системных метрик, `DCGM Exporter` для метрик GPU, `Celery Exporter` для метрик Celery) отправляют метрики в `Prometheus`.

